# 센트로이드 이후 파이프라인 이슈 검증 결과

**작성일**: 2026-02-06
**대상**: 260205_센트로이드이후파이프라인_수정필요사항.md 의 15개 이슈
**검증 방법**: 실제 소스코드(`ssov_v700_20260205`) 대조 확인
**배경**: "인덱스는 다 고려해서 들어간거라 문제없다" 의견에 대한 검증

---

## 결론 요약

15개 이슈 중 **4개는 실제 버그**, 나머지는 방어 코드 부재 또는 코드 품질 이슈.

"인덱스 문제없다" 의견은 **#1, #2에서 명확히 틀림**.

---

## 실제 버그 (수정 필수)

### #1 check_stars[] 미리팩 누락 — 진짜 버그

`my_star_id.c:368-391` R>3 경로에서 리팩 루프가 `r_i[]`, `b_i[]`는 앞으로 당기지만 `check_stars[]`는 그대로 둔다.

```
리팩 전: check_stars = [S1, 0, S3, 0]   r_i = [R1, -, R3, -]
리팩 후: check_stars = [S1, 0, S3, 0]   r_i = [R1, R3, -, -]   ← 어긋남
```

QUEST(`my_Attitude_Estimation.c:23`)에서 `check_stars[i]==0`이면 skip → 리팩된 `r_i[1]=R3`이 `check_stars[1]=0`이라 스킵됨. **유효 별이 누락되어 자세 추정 정확도 저하**.

### #2 star_mg 카탈로그 인덱싱 오류 — 진짜 버그

`sensor_mgr.c:77`에서 `star_mg[i]`의 `i`는 검출 인덱스(0~14)인데, `tables.h`의 `star_mg[]`는 카탈로그 인덱스(0~1601). 올바른 코드는 `star_mg[idenStars[i] - 1]`.

RS422 cmd "3,2" 응답의 별 등급이 전부 엉뚱한 값. 지상국이 받는 등급 데이터가 실제 식별 별과 무관.

### #4 Pyramid() 스택 오버플로 — 진짜 버그

`Pyramid()` 로컬 변수 ~14KB + `star_ID()` 로컬 ~5KB = **~19KB**.
FreeRTOS task 스택 `TASK_A_STACK_SIZE=4096` words = **16KB**. 초과.

`-O2` 최적화로 지금까지 버텼을 가능성 있으나, R>3 경로 진입 시 스택 침범 위험.

### #8 kvector_table 배열 경계 미검증 — 진짜 버그

`my_star_id.c:111-116`에서 `kbot`, `ktop` 계산 후 범위 체크 없이 `kvector_table[(kbot-1)*3]` 접근. `kbot≤0`이면 음수 인덱스, 큰 값이면 86102 초과 → 메모리 접근 오류.

---

## 수정 권장 (방어 코드 부재)

| # | 이슈 | 판정 | 비고 |
|---|------|------|------|
| 3 | 쿼터니언 정규화 div/0 | 수식은 맞음, 가드 없음 | gamma=0, x=0일 때 발생 |
| 6 | Newton-Raphson J=0 | 가드 없음 | 특수 별 배치에서 NaN |
| 7 | inv3_3 det=0 | 가드 없음 | 특이 행렬에서 Inf |
| 9 | Commit() 비원자적 | 레이스 가능 | taskENTER_CRITICAL 감싸면 됨 |
| 11 | refer_star 미초기화 | `int result;` 초기값 없음 | `result = re`로 초기화 |
| 12 | cli_starRun bare return | int 함수에서 값 없이 return | UB |
| 13 | 주석 `*/` → `/` | #define 한 줄이라 대부분 OK | 안전하게 수정 권장 |

---

## 문제없는 것 (코드 품질)

| # | 이슈 | 판정 |
|---|------|------|
| 5 | Euler 섀도잉 | 현재 Euler 미사용, 영향 없음 |
| 10 | minLoc_ 8MB 배열 | 데드 코드 (호출 안 됨) |
| 14 | 더블 세미콜론 | 기능 영향 없음 |
| 15 | globalV.h 전역 정의 | -fcommon으로 현재 동작 |

---

## 수정 우선순위

```
즉시:  #1 (check_stars 리팩 5줄) → #2 (star_mg 1줄) → #4 (static 2개)
조속히: #8 (범위 체크 4줄) → #3, #6, #7 (가드 각 3~5줄)
여유시: #9, #11, #12, #13
```
